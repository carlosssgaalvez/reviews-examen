<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ReViews - Opiniones</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 400px; width: 100%; border-radius: 8px; margin-bottom: 20px;}
        .rating { color: gold; font-weight: bold; }
    </style>
</head>
<body>
    <nav class="container-fluid">
        <ul><li><strong>‚≠ê ReViews</strong></li></ul>
        <ul>
            {% if user %}
                <li>{{ user.name }}</li>
                <li><a href="/logout" role="button" class="secondary">Salir</a></li>
            {% else %}
                <li><a href="/login" role="button">Entrar con Google</a></li>
            {% endif %}
        </ul>
    </nav>

    <main class="container">
        {% if user %}
            <form action="/" method="get" style="display: flex; gap: 10px;">
                <input type="text" name="search_address" placeholder="Buscar direcci√≥n para centrar mapa...">
                <button type="submit" style="width: auto;">Buscar en Mapa</button>
            </form>
            <div id="map"></div>

            <article>
                <header>‚úçÔ∏è Nueva Rese√±a</header>
                <form action="/add" method="post" enctype="multipart/form-data">
                    <div class="grid">
                        <input type="text" name="establishment" placeholder="Nombre (ej: Casa Lola)" required>
                        <input type="text" name="address" placeholder="Direcci√≥n (ej: Calle Granada 46, M√°laga)" required>
                    </div>
                    <label>Valoraci√≥n (0-5): <input type="number" name="rating" min="0" max="5" required></label>
                    <label>Foto: <input type="file" name="image"></label>
                    <button type="submit">Publicar Rese√±a</button>
                </form>
            </article>

            <h3>Rese√±as Recientes</h3>
            <div class="grid">
                {% for review in reviews %}
                <article>
                    <header>
                        <strong>{{ review.establishment }}</strong>
                        <span class="rating">‚òÖ {{ review.rating }}/5</span>
                    </header>
                    <p>üìç {{ review.address }}</p>
                    <p><small>GPS: {{ review.coordinates.lat }}, {{ review.coordinates.lon }}</small></p>
                    <footer>
                        <a href="/review/{{ review._id }}" role="button" class="outline">Ver Detalles T√©cnicos</a>
                    </footer>
                </article>
                {% endfor %}
            </div>

        {% else %}
            <article style="text-align: center;">
                <h2>Bienvenido a ReViews</h2>
                <p>Debes identificarte para ver y crear rese√±as.</p>
                <a href="/login" role="button">Iniciar Sesi√≥n</a>
            </article>
        {% endif %}
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    {% if user %}
    <script>
        // Inicializar mapa centrado en lo que diga el backend 
        var map = L.map('map').setView({{ map_center | tojson }}, 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

        // A√±adir marcadores de las rese√±as [cite: 355]
        var reviews = {{ reviews | tojson }};
        reviews.forEach(r => {
            if(r.coordinates.lat != 0) {
                L.marker([r.coordinates.lat, r.coordinates.lon])
                 .addTo(map)
                 .bindPopup(`<b>${r.establishment}</b><br>‚òÖ ${r.rating}`);
            }
        });
    </script>
    {% endif %}
</body>
</html>